name: Daily Automated Activity Log

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-daily-log:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate daily content (manual override supported)
        run: |
          DATE=$(date '+%Y-%m-%d')

          # Read previous totals safely as strings
          DAY=$(jq -r '.day // 0' state.json)
          TOTAL_SESSIONS=$(jq -r '.sessions_completed // 0' state.json)
          TOTAL_CONCEPTS=$(jq -r '.concepts_reviewed // 0' state.json)
          TODAY_PROJECT=$(jq -r '.today.project // ""' state.json)
          TODAY_LEARNING=$(jq -r '.today.learning // ""' state.json)
          TODAY_SKILL=$(jq -r '.today.skill // ""' state.json)
          TODAY_SESSIONS=$(jq -r '.today.sessions // 0' state.json)
          TODAY_CONCEPTS=$(jq -r '.today.concepts // 0' state.json)

          # Default random content if manual override is empty
          if [ -n "$TODAY_PROJECT" ]; then
            PROJECT="$TODAY_PROJECT"
            LEARNING="$TODAY_LEARNING"
            SKILL="$TODAY_SKILL"
            SESSIONS="$TODAY_SESSIONS"
            CONCEPTS="$TODAY_CONCEPTS"
          else
            PROJECT=$(jq -r '.projects[]' topics.json | shuf -n 1)
            LEARNING=$(jq -r '.learning[]' topics.json | shuf -n 1)
            SKILL=$(jq -r '.skills[]' topics.json | shuf -n 1)
            SESSIONS=$((RANDOM % 3 + 1))
            CONCEPTS=$((RANDOM % 5 + 2))
          fi

          # Calculate totals safely in Bash
          NEW_TOTAL_SESSIONS=$((TOTAL_SESSIONS + SESSIONS))
          NEW_TOTAL_CONCEPTS=$((TOTAL_CONCEPTS + CONCEPTS))
          NEW_DAY=$((DAY + 1))

          # Append daily entry to README.md
          echo -e "## $DATE\nContinued work on $PROJECT\nFocused study on $LEARNING\nStrengthened $SKILL through hands-on practice\nStudy sessions today: $SESSIONS\nTotal sessions completed: $NEW_TOTAL_SESSIONS\nTotal concepts reviewed: $NEW_TOTAL_CONCEPTS\n" >> README.md

          # Update state.json safely using jq filter with strings
          jq --arg day "$NEW_DAY" \
             --arg sessions "$NEW_TOTAL_SESSIONS" \
             --arg concepts "$NEW_TOTAL_CONCEPTS" \
             '.day = ($day | tonumber) 
              | .sessions_completed = ($sessions | tonumber) 
              | .concepts_reviewed = ($concepts | tonumber)
              | .today.project = ""
              | .today.learning = ""
              | .today.skill = ""
              | .today.sessions = 0
              | .today.concepts = 0' \
             state.json > state.tmp && mv state.tmp state.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md state.json
          git commit -m "Daily activity update: $DATE" || exit 0
          git push
